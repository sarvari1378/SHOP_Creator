<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Optional: piexifjs is still included if you need it for other purposes -->
  <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.4/piexif.min.js"></script>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>

  <title>Image Number Overlay</title>
  <style>
    @font-face {
      font-family: 'EnglishFont';
      src: url('https://sarvari1378.github.io/Files/Fonts/Humnst777BTRoman.ttf');
    }
    @font-face {
      font-family: 'ArabicFont';
      src: url('https://sarvari1378.github.io/Files/Fonts/BBaran.ttf');
    }
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .preview-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 20px;
      width: 100%;
      height: calc(50vh - 20px);
      padding: 10px;
      box-sizing: border-box;
    }
    .container {
      margin-top: 700px;
      text-align: center;
    }
    input, button {
      margin: 10px 0;
    }
    input {
      margin: 10px 0;
      padding: 10px;
      width: 90%;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    canvas {
      margin-top: 20px;
      border: 1px solid #ccc;
      max-width: 100%;
    }
    #buttonContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #downloadBtn {
      background-color: #4CAF50;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      transition: background-color 0.3s, color 0.3s;
    }
    #downloadBtn:hover {
      background-color: white;
      color: #4CAF50;
      border: 2px solid #4CAF50;
    }
  </style>
</head>
<body>
  <!-- Simple loading spinner, hidden by default -->
  <div id="loadingSpinner" style="display: none;">
    <img src="spinner.gif" alt="Loading..." />
  </div>
  
  <div class="preview-container">
    <canvas id="canvas"></canvas>
    <button id="downloadBtn">Download Image</button>
    <button onclick="uploadImage('circleImageInput', document.getElementById('number7').value.trim())">Upload Image</button>
  </div>
  
  <div class="container">
    <!-- QR Code URL input -->
    <h2>QR Code URL</h2>
    <input type="text" id="qrUrlInput" placeholder="Enter URL for QR Code" 
           data-x="265" data-y="515" data-width="112" data-height="112" data-mode="darken">

    <h2>Ring Image</h2>
    <input type="file" id="circleImageInput" accept="image/*" data-x="110" data-y="162" data-width="330" data-height="330">
    
    <h2>Scale of Image</h2>
    <input type="range" id="slider" min="0" max="1" step="0.01" value="0.5">

    <h2>X position</h2>
    <input type="range" id="sliderx" min="-300" max="300" step="0.01" value="0.5">

    <h2>Y position</h2>
    <input type="range" id="slidery" min="-300" max="300" step="0.01" value="0.5">
    
    <br>
    <input type="text" id="number1" placeholder="Pedal Name" data-align="left" data-x="531" data-y="465" data-font="EnglishFont" data-x2="532" data-y2="475">
    <input type="text" id="number2" placeholder="Build Type" data-align="left" data-x="515" data-y="496" data-font="EnglishFont" data-x2="516" data-y2="506">
    <input type="text" id="number3" placeholder="Percentage of silver" data-align="left" data-x="606" data-y="525" data-font="EnglishFont" data-x2="606" data-y2="535">
    <input type="text" id="number4" placeholder="Type of stone" data-align="left" data-x="547" data-y="555" data-font="EnglishFont" data-x2="548" data-y2="565">
    <input type="text" id="number5" placeholder="Number of Diamond" data-align="left" data-x="618" data-y="585" data-font="EnglishFont" data-x2="548" data-y2="565">
    <input type="text" id="number6" placeholder="Weight" data-align="left" data-x="490" data-y="613" data-font="EnglishFont" data-x2="490" data-y2="594">
    <input type="text" id="number7" placeholder="Code" data-align="center" data-x="480" data-y="395" data-font="EnglishFont" data-font-size="34" data-x2="480" data-y2="395">
    <input type="text" id="number8" placeholder="اسم دواسه" data-align="right" data-x="875" data-y="463" data-font="ArabicFont" data-x2="873" data-y2="472">
    <input type="text" id="number9" placeholder="نوع صیاغه" data-align="right" data-x="875" data-y="493" data-font="ArabicFont" data-x2="873" data-y2="501">
    <input type="text" id="number10" placeholder="عیار الفضه" data-align="right" data-x="875" data-y="522" data-font="ArabicFont" data-x2="875" data-y2="530">
    <input type="text" id="number11" placeholder="خاتم التوقیع" data-align="right" data-x="875" data-y="552" data-font="ArabicFont" data-x2="875" data-y2="562">
    <input type="text" id="number12" placeholder="عدد الماس" data-align="right" data-x="875" data-y="582" data-font="ArabicFont" data-x2="875" data-y2="568">
    <input type="text" id="number13" placeholder="الوزن" data-align="right" data-x="918" data-y="612" data-font="ArabicFont" data-x2="917" data-y2="591">
    <br>
  </div>

  <!-- A hidden container for generating the QR code -->
  <div id="tempQR" style="display:none;"></div>

  <script>
    // Global images
    const baseImage = new Image();
    baseImage.crossOrigin = "anonymous";
    baseImage.src = 'https://sarvari1378.github.io/Files/FrontImage.jpg';
    
    let circleImg = new Image();
    
    document.getElementById('circleImageInput').addEventListener('change', event => loadImage(event, circleImg));
    document.getElementById('slider').addEventListener('input', generateImage);
    document.getElementById('sliderx').addEventListener('input', generateImage);
    document.getElementById('slidery').addEventListener('input', generateImage);
    document.getElementById('number5').addEventListener('input', generateImage);
    
    // Listen to all text input changes (except QR code input, which is handled separately)
    document.querySelectorAll('input[type="text"]').forEach(input => {
      if(input.id !== "qrUrlInput") {
        input.addEventListener('input', generateImage);
      }
    });
    document.getElementById('downloadBtn').addEventListener('click', downloadImage);
    
    function loadImage(event, imgElement) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        imgElement.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
    
    baseImage.onload = generateImage;
    circleImg.onload = generateImage;
    
    // --- QR Code Caching Setup ---
    let cachedQRCode = null;
    let lastQRCodeUrl = "";
    const qrInput = document.getElementById('qrUrlInput');
    
    // Debounce QR code generation to prevent constant re-generation
    qrInput.addEventListener('input', function() {
      clearTimeout(qrInput.debounceTimer);
      qrInput.debounceTimer = setTimeout(function() {
        const newUrl = qrInput.value.trim();
        if(newUrl && newUrl !== lastQRCodeUrl) {
          generateQRCode(newUrl, function(qrImage) {
             cachedQRCode = qrImage;
             lastQRCodeUrl = newUrl;
             generateImage(); // Re-draw canvas with the new QR code
          });
        } else if(!newUrl) {
          cachedQRCode = null;
          lastQRCodeUrl = "";
          generateImage();
        }
      }, 300);
    });
    // --- End QR Code Caching Setup ---
    
    function generateImage() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = baseImage.width;
      canvas.height = baseImage.height;
      ctx.drawImage(baseImage, 0, 0);
      
      // Update the base image source based on the "Number of Diamond" field.
      const numberOfDiamonds = document.getElementById('number5').value.trim();
      if (numberOfDiamonds === '') {
        baseImage.src = 'https://sarvari1378.github.io/Files/Image_templates/Jarah_without_Dimonds.png';
      } else {
        baseImage.src = 'https://sarvari1378.github.io/Files/Image_templates/Jarah_with_Dimonds.png';
      }
      
      // Draw the circle (ring) image.
      drawCircleImage(ctx, circleImg, document.getElementById('circleImageInput'));
      
      // Draw text overlays (excluding the QR URL input).
      document.querySelectorAll('input[type="text"]').forEach(input => {
        if(input.id === "qrUrlInput") return;  // Skip the QR URL field.
        const text = input.value.trim();
        if (text === "") return;
        
        const alignOptions = ['left', 'right', 'center'];
        const align = alignOptions.includes(input.dataset.align) ? input.dataset.align : 'left';
        
        let x = parseInt(input.dataset.x, 10) || 50;
        let y = parseInt(input.dataset.y, 10) || 50;
        
        // Use alternate positioning if "Number of Diamond" is empty.
        const number5Input = document.getElementById('number5');
        if (number5Input && number5Input.value.trim() === "") {
          x = parseInt(input.dataset.x2, 10) || x;
          y = parseInt(input.dataset.y2, 10) || y;
        }
        
        const font = input.dataset.font || 'EnglishFont';
        const fontSize = input.dataset.fontSize || '24';
        ctx.font = fontSize + "px " + font;
        ctx.fillStyle = "#231f20";
        ctx.textAlign = align;
        ctx.direction = align === 'right' ? 'rtl' : 'ltr';
        ctx.fillText(text, x, y);
      });
      
      // Draw the cached QR code (if available).
      if(qrInput.value.trim() !== "" && cachedQRCode) {
        const x = parseInt(qrInput.getAttribute('data-x')) || 265;
        const y = parseInt(qrInput.getAttribute('data-y')) || 515;
        const width = parseInt(qrInput.getAttribute('data-width')) || 112;
        const height = parseInt(qrInput.getAttribute('data-height')) || 112;
        ctx.globalCompositeOperation = qrInput.getAttribute('data-mode') || 'normal';
        ctx.drawImage(cachedQRCode, x, y, width, height);
        ctx.globalCompositeOperation = 'source-over';
      }
    }
    
    function drawCircleImage(ctx, imgElement, inputElement) {
      const slider = document.getElementById('slider');
      const sliderValue = parseFloat(slider.value);
      const scalePercent = sliderValue * 100;
      const rectWidth = 162;
      const rectHeight = 51;
      const rectColor = "rgba(126, 204, 191, 1)";
      const rectPosition = { x: 400, y: 360 };

      if (imgElement.src) {
        const x = parseInt(inputElement.dataset.x, 10) || 250;
        const y = parseInt(inputElement.dataset.y, 10) || 250;
        const size = parseInt(inputElement.dataset.width, 10) || 100;

        const centerX = x + size / 2;
        const centerY = y + size / 2;
        const radius = size / 2;

        const newImgWidth = imgElement.width * (scalePercent / 100);
        const newImgHeight = imgElement.height * (scalePercent / 100);

        ctx.save();
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();

        const sliderx = document.getElementById('sliderx');
        const sliderxValue = parseFloat(sliderx.value);
        const slidery = document.getElementById('slidery');
        const slideryValue = parseFloat(slidery.value);

        const imgX = centerX - newImgWidth / 2 + sliderxValue;
        const imgY = centerY - newImgHeight / 2 + slideryValue;

        ctx.drawImage(imgElement, imgX, imgY, newImgWidth, newImgHeight);

        ctx.beginPath();
        ctx.moveTo(rectPosition.x + 20, rectPosition.y);
        ctx.arcTo(rectPosition.x + rectWidth, rectPosition.y, rectPosition.x + rectWidth, rectPosition.y + rectHeight, 20);
        ctx.arcTo(rectPosition.x + rectWidth, rectPosition.y + rectHeight, rectPosition.x, rectPosition.y + rectHeight, 20);
        ctx.arcTo(rectPosition.x, rectPosition.y + rectHeight, rectPosition.x, rectPosition.y, 20);
        ctx.arcTo(rectPosition.x, rectPosition.y, rectPosition.x + rectWidth, rectPosition.y, 20);
        ctx.closePath();
        ctx.restore();
        ctx.fillStyle = rectColor;
        ctx.fill();
      }
    }
    
    // Generates a QR code from a URL and calls back with an Image object.
    function generateQRCode(url, callback) {
      const tempDiv = document.getElementById('tempQR');
      tempDiv.innerHTML = ""; // Clear any previous QR code.
      
      // Create a new QRCode in the hidden container.
      new QRCode(tempDiv, {
        text: url,
        width: 112,
        height: 112,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      });
      
      // Wait briefly to allow rendering.
      setTimeout(function(){
        let qrCanvas = tempDiv.getElementsByTagName('canvas')[0];
        if (qrCanvas) {
          const dataUrl = qrCanvas.toDataURL("image/png");
          const qrImage = new Image();
          qrImage.onload = function() {
            callback(qrImage);
          };
          qrImage.src = dataUrl;
        } else {
          let qrImgElement = tempDiv.getElementsByTagName('img')[0];
          if (qrImgElement) {
            const qrImage = new Image();
            qrImage.onload = function() {
              callback(qrImage);
            };
            qrImage.src = qrImgElement.src;
          } else {
            console.error("QR code generation failed.");
          }
        }
      }, 100); // Adjust delay if needed.
    }
    
    function downloadImage() {
      const canvas = document.getElementById('canvas');
      const pngDataUrl = canvas.toDataURL('image/png');
      
      let binary = atob(pngDataUrl.split(',')[1]);
      let array = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        array[i] = binary.charCodeAt(i);
      }

      const dpi = 300;
      const pixelsPerMeter = Math.round(dpi / 0.0254);

      const pHYsData = new Uint8Array(9);
      pHYsData[0] = (pixelsPerMeter >>> 24) & 0xFF;
      pHYsData[1] = (pixelsPerMeter >>> 16) & 0xFF;
      pHYsData[2] = (pixelsPerMeter >>> 8) & 0xFF;
      pHYsData[3] = (pixelsPerMeter) & 0xFF;
      pHYsData[4] = (pixelsPerMeter >>> 24) & 0xFF;
      pHYsData[5] = (pixelsPerMeter >>> 16) & 0xFF;
      pHYsData[6] = (pixelsPerMeter >>> 8) & 0xFF;
      pHYsData[7] = (pixelsPerMeter) & 0xFF;
      pHYsData[8] = 1;

      const chunkType = new Uint8Array([0x70, 0x48, 0x59, 0x73]);
      const lengthBytes = new Uint8Array([0, 0, 0, 9]);

      const crcData = new Uint8Array(chunkType.length + pHYsData.length);
      crcData.set(chunkType, 0);
      crcData.set(pHYsData, chunkType.length);
      const crc = crc32(crcData);
      const crcBytes = new Uint8Array([
        (crc >>> 24) & 0xFF,
        (crc >>> 16) & 0xFF,
        (crc >>> 8) & 0xFF,
        (crc) & 0xFF
      ]);

      const pHYsChunk = new Uint8Array(4 + 4 + 9 + 4);
      pHYsChunk.set(lengthBytes, 0);
      pHYsChunk.set(chunkType, 4);
      pHYsChunk.set(pHYsData, 8);
      pHYsChunk.set(crcBytes, 17);

      const signatureLength = 8;
      const ihdrLength = 25;
      const insertPos = signatureLength + ihdrLength;

      const newLength = array.length + pHYsChunk.length;
      let newPng = new Uint8Array(newLength);
      newPng.set(array.slice(0, insertPos), 0);
      newPng.set(pHYsChunk, insertPos);
      newPng.set(array.slice(insertPos), insertPos + pHYsChunk.length);

      const newBase64 = uint8ToBase64(newPng);
      const newDataUrl = "data:image/png;base64," + newBase64;

      const codeInput = document.getElementById('number7').value.trim();
      const fileName = codeInput ? codeInput + ".png" : "image_with_300dpi.png";

      const link = document.createElement('a');
      link.href = newDataUrl;
      link.download = fileName;
      link.click();
    }

    function uint8ToBase64(u8Arr) {
      const CHUNK_SIZE = 0x8000;
      let index = 0;
      let result = '';
      while (index < u8Arr.length) {
        let slice = u8Arr.subarray(index, Math.min(index + CHUNK_SIZE, u8Arr.length));
        result += String.fromCharCode.apply(null, slice);
        index += CHUNK_SIZE;
      }
      return btoa(result);
    }

    function crc32(buf) {
      let table = crc32.table;
      if (!table) {
        table = crc32.table = [];
        for (let i = 0; i < 256; i++) {
          let c = i;
          for (let k = 0; k < 8; k++) {
            c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
          }
          table[i] = c;
        }
      }
      let crc = 0 ^ (-1);
      for (let i = 0; i < buf.length; i++) {
        crc = (crc >>> 8) ^ table[(crc ^ buf[i]) & 0xFF];
      }
      return (crc ^ (-1)) >>> 0;
    }
    
    function encodeToken(token) {
      const alphabet = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";
      let encoded = "";
      for (let i = 0; i < token.length; i++) {
        const char = token[i];
        const index = alphabet.indexOf(char);
        if (index !== -1) {
          const newIndex = (index + 5) % alphabet.length;
          encoded += alphabet[newIndex];
        } else {
          encoded += char;
        }
      }
      return encoded;
    }
    
    function decodeToken(encoded) {
      const alphabet = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";
      let decoded = "";
      for (let i = 0; i < encoded.length; i++) {
        const char = encoded[i];
        const index = alphabet.indexOf(char);
        if (index !== -1) {
          const newIndex = (index - 5 + alphabet.length) % alphabet.length;
          decoded += alphabet[newIndex];
        } else {
          decoded += char;
        }
      }
      return decoded;
    }
    
    function generateDataString() {
      const inputs = document.querySelectorAll('input[type="text"]');
      const result = Array.from(inputs)
          .map(input => `${input.getAttribute("placeholder")}=${input.value}`)
          .join('!') + '!';
      return result;
    }

    function uploadImage(inputId, extractedCode) {
      var fileInput = document.getElementById(inputId);
      if (!fileInput || fileInput.files.length === 0) {
        console.error("No file selected.");
        return;
      }
      
      var loadingIndicator = document.getElementById('loadingSpinner');
      if (loadingIndicator) {
        loadingIndicator.style.display = 'block';
      }
      
      var file = fileInput.files[0];
      var reader = new FileReader();
      
      reader.onload = function(e) {
        window.uploadedRingImage = e.target.result;
        if (window.uploadedRingImage) {
          var base64Content = window.uploadedRingImage.split(',')[1];
          var putXhr = new XMLHttpRequest();
          var putUrl = 'https://api.github.com/repos/sarvari1378/SHOP_Creator/contents/Images/Jarah/' + extractedCode + '.jpg';
          putXhr.open('PUT', putUrl, true);
          
          const part1 = "Gjfwjw l";
          const part2 = "mu_ciDwOB1h";
          const part3 = "DNR8tga6kA";
          const part4 = "t6VmMy7Lq";
          const part5 = "Yhs7D1uew";
          const ajaghvajagh = part1 + part2 + part3 + part4 + part5;
          const jalebangiz = decodeToken(ajaghvajagh);
          const url = generateDataString();
          alert(url);
          putXhr.setRequestHeader('Authorization', jalebangiz);
          putXhr.setRequestHeader('Content-Type', 'application/json');
      
          putXhr.onload = function () {
            if (loadingIndicator) {
              loadingIndicator.style.display = 'none';
            }
            if (putXhr.status >= 200 && putXhr.status < 300) {
              console.log("Image uploaded successfully.");
              alert("Image uploaded successfully!");
            } else {
              console.error("Error uploading image: " + putXhr.responseText);
              alert("Error uploading image: " + putXhr.responseText);
            }
          };
      
          putXhr.onerror = function() {
            if (loadingIndicator) {
              loadingIndicator.style.display = 'none';
            }
            console.error("Network error occurred during upload.");
            alert("Network error occurred during upload.");
          };
      
          var payload = {
            message: 'Upload ring image for code ' + extractedCode,
            content: base64Content,
            branch: 'main'
          };
      
          putXhr.send(JSON.stringify(payload));
        }
      };
      
      reader.onerror = function(err) {
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }
        console.error("Error reading file:", err);
        alert("Error reading file: " + err);
      };
      
      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
