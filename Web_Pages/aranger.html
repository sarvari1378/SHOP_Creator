<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Creator</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        canvas { border: 1px solid black; margin-top: 10px; }
    </style>
    <!-- Include piexif.js -->
    <script src="https://cdn.jsdelivr.net/npm/piexifjs@1.0.0/piexif.min.js"></script>
</head>
<body>
    <h2>Create a Canvas</h2>
    <label>Width (cm): <input type="number" id="widthCm" value="15" onchange="updateCanvasSize()"></label>
    <label>Height (cm): <input type="number" id="heightCm" value="15" onchange="updateCanvasSize()"></label>
    <label>DPI: <input type="number" id="dpi" value="96" onchange="updateCanvasSize()"></label>
    <br><br>
    <label>Image Gap: <input type="number" id="gap" value="10" onchange="updateCanvasSize()"></label>
    <br><br>
    <!-- Allow multiple images to be selected -->
    <input type="file" id="imageInput" accept="image/*" multiple onchange="addImages(event)">
    <br><br>
    <canvas id="canvas"></canvas>
    <br><br>
    <!-- Download button -->
    <button id="downloadBtn" onclick="downloadCanvas()">Download Canvas</button>

    <script>
        let images = []; // Array to store all images
        let canvasWidth = 500;
        let canvasHeight = 500;
        let dpi = 96;
        let gap = 10;

        function cmToPixels(cm, dpi) {
            return cm * (dpi / 2.54); // Convert cm to pixels based on DPI
        }

        function updateCanvasSize() {
            const widthCm = parseFloat(document.getElementById('widthCm').value);
            const heightCm = parseFloat(document.getElementById('heightCm').value);
            dpi = parseInt(document.getElementById('dpi').value);
            gap = parseInt(document.getElementById('gap').value);

            // Convert from cm to pixels
            canvasWidth = cmToPixels(widthCm, dpi);
            canvasHeight = cmToPixels(heightCm, dpi);

            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            canvas.style.width = widthCm + 'cm';
            canvas.style.height = heightCm + 'cm';

            ctx.clearRect(0, 0, canvas.width, canvas.height);  // Clear canvas

            // Redraw all images on the canvas
            let x = gap;
            let y = gap;
            let rowHeight = 0;

            images.forEach((image) => {
                // If the image goes out of bounds horizontally, move to the next row
                if (x + image.width > canvas.width) {
                    x = gap;
                    y += rowHeight + gap;
                    rowHeight = 0;
                }

                // Draw the image at the specified position
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image.img, x, y);

                // Update x position for next image
                x += image.width + gap;
                rowHeight = Math.max(rowHeight, image.height); // Update row height based on current image height
            });
        }

        function addImages(event) {
            const input = event.target;
            const files = input.files; // Get all selected files

            if (files.length === 0) return;

            Array.from(files).forEach((file) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        // Add the image to the images array
                        images.push({ img: img, width: img.width, height: img.height });
                        updateCanvasSize(); // Re-render the canvas with updated images
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function downloadCanvas() {
            const canvas = document.getElementById('canvas');
            const dpi = parseInt(document.getElementById('dpi').value); // Get DPI from user input
            const widthCm = parseFloat(document.getElementById('widthCm').value); // Get canvas width in cm
            const heightCm = parseFloat(document.getElementById('heightCm').value); // Get canvas height in cm

            // Convert the width and height from cm to pixels based on the DPI
            const widthPx = cmToPixels(widthCm, dpi);
            const heightPx = cmToPixels(heightCm, dpi);

            // Set the canvas size to the calculated width and height in pixels
            canvas.width = widthPx;
            canvas.height = heightPx;

            // Draw the current content of the canvas
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);  // Clear canvas before drawing
            let x = gap;
            let y = gap;
            let rowHeight = 0;

            images.forEach((image) => {
                // If the image goes out of bounds horizontally, move to the next row
                if (x + image.width > canvas.width) {
                    x = gap;
                    y += rowHeight + gap;
                    rowHeight = 0;
                }

                // Draw the image at the specified position
                ctx.drawImage(image.img, x, y);

                // Update x position for next image
                x += image.width + gap;
                rowHeight = Math.max(rowHeight, image.height); // Update row height based on current image height
            });

            // Get the image data URL from the canvas as JPEG with quality 0.12 (high quality)
            const imageDataURL = canvas.toDataURL('image/jpeg', 0.12); // Set quality to 12% (highest quality)

            // Define EXIF data for DPI and resolution
            const exifObj = {
                "0th": {
                    [piexif.ImageIFD.XResolution]: [dpi, 1],
                    [piexif.ImageIFD.YResolution]: [dpi, 1],
                    [piexif.ImageIFD.ResolutionUnit]: 2 // Resolution unit is inches
                }
            };

            // Insert the EXIF data into the image
            const newExif = piexif.insert(piexif.dump(exifObj), imageDataURL);

            // Create a download link
            const link = document.createElement('a');
            link.href = newExif;
            link.download = 'canvas_image_with_exif.jpg'; // Set the download filename
            link.click(); // Trigger the download
        }
    </script>
</body>
</html>
